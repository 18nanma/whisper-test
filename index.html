<!doctype html><html lang="en"><head><meta charset="utf-8"/><link rel="icon" href="/whisper-test/favicon.ico"/><meta name="viewport" content="width=device-width,initial-scale=1"/><meta name="theme-color" content="#000000"/><meta name="description" content="ScribeAR - an accessibility app by the University of Illinois Urbana-Champaign"/><meta http-equiv="origin-trial" content="AvwoDBEybY9cD61RRP3B1Ht0d3pjUQ1NsVUVovw/kix7fuJALxMOG/aoQxeTAjkwnxi+BNCWMwwe/hENKhM/aQMAAAB7eyJvcmlnaW4iOiJodHRwczovLzE4bmFubWEuZ2l0aHViLmlvOjQ0MyIsImZlYXR1cmUiOiJVbnJlc3RyaWN0ZWRTaGFyZWRBcnJheUJ1ZmZlciIsImV4cGlyeSI6MTY4ODA4MzE5OSwiaXNTdWJkb21haW4iOnRydWV9"><link rel="apple-touch-icon" href="/whisper-test/logo192.png"/><link rel="manifest" href="/whisper-test/manifest.json"/><script src="helpers.js" type="text/jsx"></script><title>ScribeAR</title><script defer="defer" src="/whisper-test/static/js/main.d395e937.js"></script><link href="/whisper-test/static/css/main.073c9b0a.css" rel="stylesheet"></head><body><noscript>You need to enable JavaScript to run this app.</noscript><div id="input" style="z-index:100000"><button id="start" onclick="onStart()" disabled="disabled" style="z-index:100000">Start</button> <button id="stop" onclick="onStop()" disabled="disabled" style="z-index:100000">Stop</button> <button id="clear" onclick="clearCache()" style="z-index:100000">Clear Cache</button></div><textarea id="output" rows="20"></textarea> <button id="fetch-whisper-tiny-en" onclick='loadWhisper("tiny.en")' style="z-index:10000">tiny.en (75 MB)</button><div id="root"></div><script type="text/javascript">var context=null,audio=null,audio0=null,instance=null,model_whisper=null,Module={setStatus:function(e){console.log("js: "+e)},monitorRunDependencies:function(e){},preRun:function(){console.log("js: Preparing ...")},postRun:function(){console.log("js: Initialized successfully!")}};let dbVersion=1,dbName="whisper.ggerganov.com",indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;function storeFS(e,t){try{Module.FS_unlink(e)}catch(e){}Module.FS_createDataFile("/",e,t,!0,!0),console.log("storeFS: stored model: "+e+" size: "+t.length),console.log('model-whisper-status loaded "'+model_whisper+'"!'),null!=model_whisper&&(document.getElementById("start").disabled=!1,document.getElementById("stop").disabled=!0)}function loadWhisper(e){alert("clicked");let t={"tiny.en":"https://angrave.web.engr.illinois.edu/scribear/data/ggml-model-whisper-tiny.en.bin","base.en":"https://whisper.ggerganov.com/ggml-model-whisper-base.en.bin"}[e],o={"tiny.en":75,"base.en":142}[e];model_whisper=e,document.getElementById("fetch-whisper-tiny-en").style.display="none",cbProgress=function(e){console.log(Math.round(100*e)+"%")},cbCancel=function(){var e;(e=document.getElementById("fetch-whisper-tiny-en"))&&(e.style.display="inline-block")},window.loadRemote(t,"whisper.bin",o,cbProgress,storeFS,cbCancel,printTextarea)}const kSampleRate=16e3,kRestartRecording_s=120,kIntervalAudio_ms=3e3;var mediaRecorder=null,doRecording=!1,startTime=0;function stopRecording(){Module.set_status("paused"),doRecording=!1,audio0=null,audio=null,context=null}function startRecording(){context||(context=new AudioContext({sampleRate:kSampleRate,channelCount:1,echoCancellation:!1,autoGainControl:!0,noiseSuppression:!0})),Module.set_status(""),document.getElementById("start").disabled=!0,document.getElementById("stop").disabled=!1,doRecording=!0,startTime=Date.now();var e=[],t=null;navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(o){t=o,(mediaRecorder=new MediaRecorder(t)).ondataavailable=function(t){e.push(t.data);var o=new Blob(e,{type:"audio/ogg; codecs=opus"}),n=new FileReader;n.onload=function(e){var t=new Uint8Array(n.result);context&&context.decodeAudioData(t.buffer,(function(e){var t=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),o=t.createBufferSource();o.buffer=e,o.connect(t.destination),o.start(0),t.startRendering().then((function(e){audio=e.getChannelData(0);var t=new Float32Array(null==audio0?audio.length:audio0.length+audio.length);null!=audio0&&t.set(audio0,0),t.set(audio,null==audio0?0:audio0.length),instance&&Module.set_audio(instance,t)}))}),(function(e){audio=null}))},n.readAsArrayBuffer(o)},mediaRecorder.onstop=function(e){doRecording&&setTimeout((function(){startRecording()}))},mediaRecorder.start(kIntervalAudio_ms)})).catch((function(e){console.log("js: error getting audio stream: "+e)}));var o=setInterval((function(){doRecording||(clearInterval(o),mediaRecorder.stop(),t.getTracks().forEach((function(e){e.stop()})),document.getElementById("start").disabled=!1,document.getElementById("stop").disabled=!0,mediaRecorder=null),null!=audio&&audio.length>kSampleRate*kRestartRecording_s&&doRecording&&(clearInterval(o),audio0=audio,audio=null,mediaRecorder.stop(),t.getTracks().forEach((function(e){e.stop()})))}),100)}window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineAudioContext=window.OfflineAudioContext||window.webkitOfflineAudioContext;var nLines=0,intervalUpdate=null,transcribedAll="";function onStart(){instance||(instance=Module.init("whisper.bin"))&&console.log("js: whisper initialized, instance: "+instance),instance?(startRecording(),intervalUpdate=setInterval((function(){var e=Module.get_transcribed();if(null!=e&&e.length>1&&(transcribedAll+=e+"<br>",++nLines>10)){var t=transcribedAll.indexOf("<br>");t>0&&(transcribedAll=transcribedAll.substring(t+4),nLines--)}}),100)):console.log("js: failed to initialize whisper")}function onStop(){stopRecording()}function convertTypedArray(e,t){var o=new ArrayBuffer(e.byteLength);new e.constructor(o).set(e);return new t(o)}var printTextarea=function(){var e=document.getElementById("output");return e&&(e.alue=""),function(t){arguments.length>1&&(t=Array.prototype.slice.call(arguments).join(" ")),console.log(t),e&&(e.value+=t+"\n",e.scrollTop=e.scrollHeight)}}();async function clearCache(){confirm("Are you sure you want to clear the cache?\nAll the models will be downloaded again.")&&indexedDB.deleteDatabase(dbName)}async function fetchRemote(e,t,o){o("fetchRemote: downloading with fetch()...");const n=await fetch(e,{method:"GET",headers:{"Content-Type":"application/octet-stream","Access-Control-Allow-Origin":"*","Cross-Origin-Embedder-Policy":"require-corp","Cross-Origin-Opener-Policy":"same-origin"}});if(!n.ok)return void o("fetchRemote: failed to fetch "+e);const r=n.headers.get("content-length"),a=parseInt(r,10),i=n.body.getReader();for(var d=[],l=0,s=-1;;){const{done:e,value:n}=await i.read();if(e)break;if(d.push(n),l+=n.length,r){t(l/a);var c=Math.round(l/a*10);c!=s&&(o("fetchRemote: fetching "+10*c+"% ..."),s=c)}}var u=0,f=new Uint8Array(l);for(var m of d)f.set(m,u),u+=m.length;return f}function loadRemote(e,t,o,n,r,a,i){navigator.storage.estimate().then((function(e){i("loadRemote: storage quota: "+e.quota+" bytes"),i("loadRemote: storage usage: "+e.usage+" bytes")}));var d=indexedDB.open(dbName,dbVersion);d.onupgradeneeded=function(e){var t=e.target.result;if(1==t.version){t.createObjectStore("models",{autoIncrement:!1});i("loadRemote: created IndexedDB "+t.name+" version "+t.version)}else{e.currentTarget.transaction.objectStore("models").clear(),i("loadRemote: cleared IndexedDB "+t.name+" version "+t.version)}},d.onsuccess=function(d){var l=d.target.result.transaction(["models"],"readonly").objectStore("models").get(e);l.onsuccess=function(d){if(l.result)i('loadRemote: "'+e+'" is already in the IndexedDB'),r(t,l.result);else{if(i('loadRemote: "'+e+'" is not in the IndexedDB'),!confirm("You are about to download "+o+" MB of data.\nThe model data will be cached in the browser for future use.\n\nPress OK to continue."))return void a();fetchRemote(e,n,i).then((function(o){o&&(indexedDB.open(dbName,dbVersion).onsuccess=function(n){var d=n.target.result.transaction(["models"],"readwrite").objectStore("models").put(o,e);d.onsuccess=function(n){i('loadRemote: "'+e+'" stored in the IndexedDB'),r(t,o)},d.onerror=function(t){i('loadRemote: failed to store "'+e+'" in the IndexedDB'),a()}})}))}},l.onerror=function(e){i("loadRemote: failed to get data from the IndexedDB"),a()}},d.onerror=function(e){i("loadRemote: failed to open IndexedDB"),a()},d.onblocked=function(e){i("loadRemote: failed to open IndexedDB: blocked"),a()},d.onabort=function(e){i("loadRemote: failed to open IndexedDB: abort")}}Module={};var ENVIRONMENT_IS_NODE="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node;if(ENVIRONMENT_IS_NODE){var nodeWorkerThreads=require("worker_threads"),parentPort=nodeWorkerThreads.parentPort;parentPort.on("message",(e=>onmessage({data:e})));var fs=require("fs");Object.assign(global,{self:global,require:require,Module:Module,location:{href:__filename},Worker:nodeWorkerThreads.Worker,importScripts:function(e){(0,eval)(fs.readFileSync(e,"utf8")+"//# sourceURL="+e)},postMessage:function(e){parentPort.postMessage(e)},performance:global.performance||{now:function(){return Date.now()}}})}var initializedJS=!1,pendingNotifiedProxyingQueues=[];function threadPrintErr(){var e=Array.prototype.slice.call(arguments).join(" ");ENVIRONMENT_IS_NODE?fs.writeSync(2,e+" "):console.error(e)}function threadAlert(){var e=Array.prototype.slice.call(arguments).join(" ");postMessage({cmd:"alert",text:e,threadId:Module._pthread_self()})}var err=threadPrintErr;self.alert=threadAlert,Module.instantiateWasm=(e,t)=>{var o=new WebAssembly.Instance(Module.wasmModule,e);return t(o),Module.wasmModule=null,o.exports},self.onunhandledrejection=e=>{throw e.reason??e},self.startWorker=e=>{postMessage({cmd:"loaded"})},self.onmessage=e=>{try{if("load"===e.data.cmd){Module.wasmModule=e.data.wasmModule;for(const t of e.data.handlers)Module[t]=function(){postMessage({cmd:"callHandler",handler:t,args:[...arguments]})};if(Module.wasmMemory=e.data.wasmMemory,Module.buffer=Module.wasmMemory.buffer,Module.ENVIRONMENT_IS_PTHREAD=!0,"string"==typeof e.data.urlOrBlob)importScripts(e.data.urlOrBlob);else{var t=URL.createObjectURL(e.data.urlOrBlob);importScripts(t),URL.revokeObjectURL(t)}}else if("run"===e.data.cmd){Module.__emscripten_thread_init(e.data.pthread_ptr,0,0,1),Module.establishStackSpace(),Module.PThread.receiveObjectTransfer(e.data),Module.PThread.threadInitTLS(),initializedJS||(Module.__embind_initialize_bindings(),pendingNotifiedProxyingQueues.forEach((e=>{Module.executeNotifiedProxyingQueue(e)})),pendingNotifiedProxyingQueues=[],initializedJS=!0);try{Module.invokeEntryPoint(e.data.start_routine,e.data.arg)}catch(e){if("unwind"!=e){if(!(e instanceof Module.ExitStatus))throw e;Module.keepRuntimeAlive()||Module.__emscripten_thread_exit(e.status)}}}else"cancel"===e.data.cmd?Module._pthread_self()&&Module.__emscripten_thread_exit(-1):"setimmediate"===e.data.target||("processProxyingQueue"===e.data.cmd?initializedJS?Module.executeNotifiedProxyingQueue(e.data.queue):pendingNotifiedProxyingQueues.push(e.data.queue):e.data.cmd&&(err("worker.js received unknown command "+e.data.cmd),err(e.data)))}catch(e){throw Module.__emscripten_thread_crashed&&Module.__emscripten_thread_crashed(),e}}</script><script src="stream.js" type="text/jsx"></script><script src="libstream.worker.js" type="text/jsx"></script></body></html>